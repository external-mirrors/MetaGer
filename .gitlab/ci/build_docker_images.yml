fpm:
  stage: build_docker_images
  image: $BUILD_DOCKER_IMAGE
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
    # We need the vendor files in our final image. Make sure to not ignore the folder
    - echo '!metager/vendor' >> .dockerignore
  script:
    - docker build --network=host
        --target=production
        -f build/fpm/Dockerfile
        -t ${CI_REGISTRY_IMAGE}/$DOCKER_FPM_IMAGE_NAME:$DOCKER_FPM_IMAGE_TAG .
    - docker push ${CI_REGISTRY_IMAGE}/$DOCKER_FPM_IMAGE_NAME:$DOCKER_FPM_IMAGE_TAG
  after_script:
    - docker logout $CI_REGISTRY

cleanup_composer_image:
  stage: build_docker_images
  image: curlimages/curl
  script:
    - 'curl -X DELETE --fail -H "JOB-TOKEN: $CI_JOB_TOKEN" "$CI_API_V4_URL/projects/$CI_PROJECT_ID/registry/repositories/418/tags/$DOCKER_COMPOSER_IMAGE_TAG"'

cleanup_revision_images:
  stage: build_docker_images
  image: $DEPLOY_KUBERNETES_IMAGE
  variables:
    KEEP_N: 9   # Trim to the latest 9 revisions as the 10th will be deleted in the next stage
  script:
    - .gitlab/deployment_scripts/cleanup_revisions.sh

nginx:
  stage: build_docker_images
  image: $BUILD_DOCKER_IMAGE
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - docker build --network=host
        --target=production
        -f build/nginx/Dockerfile
        -t ${CI_REGISTRY_IMAGE}/$DOCKER_NGINX_IMAGE_NAME:$DOCKER_NGINX_IMAGE_TAG .
    - docker push ${CI_REGISTRY_IMAGE}/$DOCKER_NGINX_IMAGE_NAME:$DOCKER_NGINX_IMAGE_TAG
  after_script:
    - docker logout $CI_REGISTRY