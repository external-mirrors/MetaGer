.deploy:
  stage: deploy
  image: alpine/k8s:1.22.6
  script:
    - .gitlab/deployment_scripts/update_secret.sh

deploy_review:
  extends:
    - .deploy
  environment:
    name: review/$CI_COMMIT_REF_SLUG
    auto_stop_in: 2 days
  rules:
    - if: '$CI_COMMIT_BRANCH == "master" || $CI_COMMIT_BRANCH == "development"'
      when: never
    - if: '$CI_COMMIT_TAG || $CI_COMMIT_BRANCH'

stop_review:
  stage: stop_review
  environment:
    name: review/$CI_COMMIT_REF_SLUG
    action: stop
  script:
    - echo "Stopping Deployment..."
    - kubectl -n $KUBE_NAMESPACE delete secret $CI_COMMIT_REF_SLUG
  when: manual
  rules:
    - if: '$CI_COMMIT_BRANCH == "master" || $CI_COMMIT_BRANCH == "development"'
      when: never
    - if: '$CI_COMMIT_TAG || $CI_COMMIT_BRANCH'